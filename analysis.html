<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
      th:replace="layout :: html(~{::title}, ~{::content}, ~{::scripts})">
<head>
    <title>统计分析 - 药品不良反应监测系统</title>
</head>
<body>
<div th:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-bar-chart text-primary"></i> 统计分析</h2>
        <a th:href="@{/analysis/drug-reaction}" class="btn btn-outline-primary">
            <i class="bi bi-graph-up"></i> 药品-反应统计
        </a>
    </div>

    <!-- 统计概览 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4 th:text="${totalPatients}">0</h4>
                    <p>总患者数</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4 th:text="${totalMedications}">0</h4>
                    <p>用药记录</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4 th:text="${totalReactions}">0</h4>
                    <p>不良反应</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h4 th:text="${patientsWithReactions}">0</h4>
                    <p>有反应患者</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 药品统计 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-capsule"></i> 药品使用统计</h5>
                </div>
                <div class="card-body">
                    <canvas id="drugChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- 症状统计 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-exclamation-triangle"></i> 症状分布统计</h5>
                </div>
                <div class="card-body">
                    <canvas id="symptomChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- 发生时机统计 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-clock"></i> 发生时机统计</h5>
                </div>
                <div class="card-body">
                    <canvas id="timingChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-table"></i> 药品统计详情</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm">
                            <thead>
                            <tr>
                                <th>药品名称</th>
                                <th>使用次数</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="stat : ${drugStats}">
                                <td th:text="${stat[0]}">-</td>
                                <td th:text="${stat[1]}">-</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="scripts">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 药品统计图表
            const drugCtx = document.getElementById('drugChart').getContext('2d');
            const drugLabels = [[${#strings.listJoin(#lists.extract(drugStats, 0), ',')}]];
            const drugData = [[${#strings.listJoin(#lists.extract(drugStats, 1), ',')}]];

            new Chart(drugCtx, {
                type: 'bar',
                data: {
                    labels: drugLabels,
                    datasets: [{
                        label: '使用次数',
                        data: drugData,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // 症状统计图表
            const symptomCtx = document.getElementById('symptomChart').getContext('2d');
            const symptomLabels = [[${#strings.listJoin(#lists.extract(symptomStats, 0), ',')}]];
            const symptomData = [[${#strings.listJoin(#lists.extract(symptomStats, 1), ',')}]];

            new Chart(symptomCtx, {
                type: 'pie',
                data: {
                    labels: symptomLabels,
                    datasets: [{
                        data: symptomData,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                }
            });

            // 发生时机统计
            const timingCtx = document.getElementById('timingChart').getContext('2d');
            const timingLabels = [[${#strings.listJoin(#lists.extract(timingStats, 0), ',')}]];
            const timingData = [[${#strings.listJoin(#lists.extract(timingStats, 1), ',')}]];

            new Chart(timingCtx, {
                type: 'doughnut',
                data: {
                    labels: timingLabels,
                    datasets: [{
                        data: timingData,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                        ]
                    }]
                }
            });
        });
    </script>
</div>
</body>
</html>